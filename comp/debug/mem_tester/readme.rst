.. _mem_tester:

DDR4 Memory Tester
------------------

This component is used to test external DDR4 memory connected by 
AMM (Avalon-Memory-Mapped) interface controlled by EMIF Hard IP.
It also runs on clock generated by EMIF.
Additionally it contains :ref:`AMM_PROBE <amm_probe>` 
which is able to measure latency and data flow during communication.

Internal Architecture
^^^^^^^^^^^^^^^^^^^^^

Architecture description:

- :ref:`MI bus<mi_bus>` logic is separated into another file (mem_tester_mi.vhd)

  - :ref:`MI_ASYNC <mi_async>` is used to cross between MI bus and Avalon clock domains
  - :ref:`MI_SPLITTER_PLUS_GEN <mi_splitter_plus_gen>` divides MI bus for mem_tester, AMM_GEN and AMM_PROBE components

- :ref:`AMM_PROBE <amm_probe>` handles all the measurements (data flow, latency, r/w AMM word count)
- :ref:`AMM_GEN <amm_gen>` can be used to manually access the external memory
- LFSR_SIMPLE_RANDOM_GEN components generate random data and addresses for testing external memory
- AMM_MUX is used to select between these AMM interfaces:

  - Internal logic during memory test 
  - :ref:`AMM_GEN <amm_gen>` during the manual access
  
- The whole component is then controlled by FSM

.. image:: doc/memory_tester.svg
    :align: center
    :width: 60 %


Test of the external memory is divided into three steps:

- Writing pseudo-random data to all addresses of the memory
- Resetting pseudo-random generator (so it will generate the same data as before)
- Reading data back from the memory and comparing them with generated pseudo-random data
  
  - If the data do not match, the error counter will increment by 1 for each wrong word

Pseudo-random data are selected to increase changes in data bits, and therefore 
revealing possible problems with memory or its connection.

You can select between two addressing modes:

- Sequential indexing
- Random indexing

.. warning::
    Test with random indexing active will generate a few errors, 
    due to multiple writes to the same address.
    Its used just for measurement purpose.

.. note::
    One Avalon MM transaction (burst) is made by sending/receiving ``burst_cnt`` data words.

MI Bus Control
^^^^^^^^^^^^^^

**MI Address Space Definition**

.. code-block::

    0x0000 -- ctrl in
              0. bit -- reset
              1. bit -- reset EMIF IP
              2. bit -- run test
              3. bit -- AMM_GEN enable (connects AMM_GEN to AMM bus)
              4. bit -- random addressing enable
              5. bit -- max. one simultaneous read transaction (for measuring latency) 
              6. bit -- auto precharge request to EMIF (if connected)
    0x0004 -- ctrl out
              0. bit -- test done
              1. bit -- test successful
              2. bit -- ECC error occurred
              3. bit -- calibration success
              4. bit -- calibration fail
              5. bit -- AMM_READY
    0x0008 -- err cnt
    0x000C -- burst cnt during test 
    0x0010 -- limit address during test
    0x0014 -- refresh period 
    0x0018 -- default refresh period 
    0x0040 -- AMM_GEN   base address
    0x0060 -- AMM_PROBE base address


Following bits inside ``ctrl in`` register reacts only for rising edge:

- ``reset`` bit
- ``reset EMIF IP`` bit
- ``run test`` bit

**Usage**

Reset sequence:

- Set ``reset`` bit to ``1`` and then to ``0``
- To reset EMIF IP set ``reset EMIF IP`` bit to ``1`` and then to ``0`` and 
  wait for either ``calibration successful`` bit or ``calibration fail`` bit

Run test:

- To run the test set ``run test`` bit to ``1``
- After the test is finished ``test done`` bit will be set to ``1`` and the result will be available in ``test successful`` bit
- Error count during test will be available inside err cnt register

Sub-components
^^^^^^^^^^^^^^
.. toctree::
    :maxdepth: 1

    amm_gen/readme
    amm_probe/readme

Software
^^^^^^^^

.. toctree::
    :maxdepth: 1

    sw/readme

**References**

- `External Memory Interfaces Intel Stratix 10 FPGA IP User Guide (external) <https://www.intel.com/content/dam/www/programmable/us/en/pdfs/literature/hb/stratix-10/ug-s10-emi.pdf>`_
- `External Memory Interfaces Intel Agilex FPGA IP User Guide (external) <https://www.intel.com/content/dam/www/programmable/us/en/pdfs/literature/hb/agilex/ug-ag-emi.pdf>`_
- `Avalon Interface Specifications (external) <https://www.intel.com/content/dam/www/programmable/us/en/pdfs/literature/manual/mnl_avalon_spec.pdf>`_
